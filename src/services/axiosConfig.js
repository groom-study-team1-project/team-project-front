import React from 'react';
import axios from "axios"; import { updateToken, userLogout } from "../store/user/userSlice";  const axiosInstance = axios.create({   baseURL: "https://deepdivers.store/",   headers: {     "Content-Type": "application/json",   }, });  // Redux Toolkitê³?React Router ?µí•© export const setupAxiosInterceptors = (store, navigate) => {   // ?”ì²­ ?¸í„°?‰í„°    axiosInstance.interceptors.request.use(     (config) => {       // ?”ì²­ URL??"/api"ë¡??œì‘?˜ëŠ” ê²½ìš°?ë§Œ Authorization ?¤ë” ì¶”ê?       if (config.url.startsWith("/api")) {         const accessToken = localStorage.getItem("accessToken");         if (accessToken) {           config.headers["Authorization"] = `Bearer ${accessToken}`;         }       }       return config;     },     (error) => {       console.error("Request Interceptor Error:", error);       return Promise.reject(error);     }   );    axiosInstance.interceptors.request.use(     (config) => {       try {         const refreshToken = localStorage.getItem("refreshToken");         const accessToken = localStorage.getItem("accessToken");         // Refresh Token???„ìš”???¹ì • ?”ì²­?ë§Œ ?¤ë” ì¶”ê?         const urlsRequiringRefreshToken = ["/tokens/re-issue"];         if (urlsRequiringRefreshToken.some((url) => config.url.includes(url))) {           if (refreshToken) {             config.headers["Authorization"] = `Bearer ${accessToken}`;             config.headers["Refresh-Token"] = refreshToken; // Refresh-Token ?¤ë”??ì¶”ê?           } else {             console.warn("No Refresh Token found in localStorage.");           }         }          return config;       } catch (error) {         console.error("Error in Request Interceptor:", error);         throw error; // ?ëŸ¬ ë°œìƒ ???”ì²­??ì¤‘ë‹¨       }     },     (error) => {       console.error("Request Interceptor Error:", error);       return Promise.reject(error);     }   );    // ?‘ë‹µ ?¸í„°?‰í„°   axiosInstance.interceptors.response.use(     (response) => response,     async (error) => {       const originalRequest = error.config;       const errorCode =         error.response && error.response.data ? error.response.data.code : null;        if (         originalRequest.url.startsWith("/api") &&         errorCode.toString().startsWith("90")       ) {         switch (errorCode) {           case 9001: // ? í° ? íš¨ê¸°ê°„ ë§Œë£Œ             originalRequest._retry = true;             try {               const response = await axiosInstance.patch("/tokens/re-issue");               console.log(response);               if (response.data.status.code !== 8000) {                 throw new Error(                   response.data.status.message || "? í° ?¬ë°œê¸??¤íŒ¨"                 );               }                // ?ˆë¡œ??Access Token Redux???…ë°?´íŠ¸               store.dispatch(                 updateToken({                   accessToken: response.data.result.accessToken,                   refreshToken: response.data.result.refreshToken,                 })               );               const accessToken = response.data.result.accessToken;               // ?ë˜ ?”ì²­???ˆë¡œ??Access Token ?ìš©               if (accessToken) {                 originalRequest.headers[                   "Authorization"                 ] = `Bearer ${accessToken}`;                 console.log(originalRequest);                 return axiosInstance(originalRequest); // ?ë˜ ?”ì²­ ?¬ì‹œ??               }             } catch (refreshError) {               console.error("? í° ?¬ë°œê¸??¤íŒ¨:", refreshError);                store.dispatch(userLogout());               navigate("/"); // ë¡œê·¸???˜ì´ì§€ë¡??´ë™             }             break;            case 9000: // ê¸°í? ? í° ê´€???¤ë¥˜           case 9002:           case 9003:           case 9004:           case 9005:             console.error("? í° ê´€???¤ë¥˜ ë°œìƒ:", error.response.data.message);             store.dispatch(userLogout());             navigate("/"); // ?ˆìœ¼ë¡??´ë™             break;            default:             console.error("ê¸°í? ?¤ë¥˜ ë°œìƒ:", error.response.data.message);             store.dispatch(userLogout());             navigate("/");         }       }        return Promise.reject(error);     }   ); };  export default axiosInstance;
